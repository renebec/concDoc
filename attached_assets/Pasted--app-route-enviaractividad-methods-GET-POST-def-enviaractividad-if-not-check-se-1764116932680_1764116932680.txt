@app.route("/enviaractividad", methods=["GET", "POST"])
def enviaractividad():
    if not check_session_timeout():
        flash('Su sesión ha expirado. Por favor, inicie sesión nuevamente.', 'danger')
        return redirect(url_for('login'))

    if request.method == "GET":
        return render_template("enviaractividad.html", show_form=True)

    # --- Si entra por POST ---
    try:
        # --- Recibir datos ---
        numero_control = request.form.get("numero_control")
        plantel = request.form.get("plantel")
        pdf_file = request.files.get("pdf_file")

        # --- Validaciones ---
        if not numero_control or not pdf_file or not plantel:
            flash("Debes ingresar número de control, seleccionar un plantel y subir un PDF.", "danger")
            return redirect(url_for("enviaractividad"))

        if not pdf_file.filename.lower().endswith(".pdf"):
            flash("El archivo debe ser un PDF.", "danger")
            return redirect(url_for("enviaractividad"))

        # Validar tamaño (máx 10 MB)
        pdf_bytes = pdf_file.read()
        if len(pdf_bytes) > 10 * 1024 * 1024:
            flash("El PDF debe ser menor o igual a 10 MB.", "danger")
            return redirect(url_for("enviaractividad"))

        # Regresamos el puntero
        pdf_file.seek(0)

        # --- Conexión a la BD ---
        session_db = get_db_session()

        try:
            query = text("""
                SELECT numero_control, nombres, apellido_paterno, apellido_materno
                FROM users2
                WHERE numero_control = :nc
            """)

            user = session_db.execute(query, {"nc": numero_control}).mappings().first()

            if not user:
                flash("Número de control no encontrado en la base de usuarios.", "danger")
                return redirect(url_for("enviaractividad"))

            # --- Generar nombre único para el PDF ---
            base_name = f"{user['numero_control']}_{user['apellido_paterno']}_{user['apellido_materno']}_{user['nombres']}_{plantel}"
            base_name = secure_filename(base_name)

            # Evitar sobrescrituras (agregar timestamp)
            filename = f"{base_name}_{int(time.time())}"

            # --- Subir PDF a Cloudinary ---
            result = cloudinary.uploader.upload(
                pdf_file,
                resource_type="raw",
                folder="actividades_pdf",
                public_id=filename,
                unique_filename=False,
                overwrite=False
            )

            pdf_url = result.get("secure_url")

            # --- Insertar en la tabla actividades ---
            created_at = datetime.now(pytz.timezone("America/Mexico_City"))

            insert_actividad(
                session_db,
                numero_control=user["numero_control"],
                plantel=plantel,
                apellido_paterno=user["apellido_paterno"],
                apellido_materno=user["apellido_materno"],
                nombres=user["nombres"],
                pdf_url=pdf_url,
                created_at=created_at
            )

            session_db.commit()

        except Exception as db_err:
            session_db.rollback()

            # Si el PDF ya se subió pero hubo error en DB, se borra del servidor
            try:
                cloudinary.uploader.destroy(f"actividades_pdf/{filename}", resource_type="raw")
            except:
                pass

            print("❌ Error en DB:", db_err)
            flash("Ocurrió un error al registrar la actividad en la base de datos.", "danger")
            return redirect(url_for("enviaractividad"))

        finally:
            session_db.close()

        flash(f"PDF de {user['nombres']} {user['apellido_paterno']} enviado correctamente.", "success")
        return redirect(url_for("hello_pm1"))

    except Exception as e:
        print("❌ Error general:", e)
        flash("Ocurrió un error inesperado al procesar el registro.", "danger")
        return redirect(url_for("enviaractividad"))